ahoyapi: v1
version: 0.0.0
commands:
  drupal-rebuild:
    cmd: |
      if [[ "{{args}}" != mysql* ]]; then
          echo "You need to specify the drupal db url to use in the form mysql://root:root@localhost/db as an argument."
          exit 1
      fi
      # Ask the user if they're sure they want to delete an existing docroot.
      if [ -d docroot ]
        then
          ahoy confirm "./docroot folder alredy exists. Delete it and reinstall drupal?" && chmod -R 777 docroot/sites/default && rm -rf docroot ||
          { echo ".. skipping installation"; exit 1;}
      fi
      ahoy drush make --prepare-install dkan/drupal-org-core.make docroot --yes &&
      ln -s ../../dkan docroot/profiles/dkan &&
      ahoy drush -y si minimal --root=docroot --sites-subdir=default --db-url={{args}}
    usage: 'Builds a fully operational drupal site for dkan development in ./docroot. You must pass in the database url. Note: to install dkan also run dkan-remake and dkan-reinstall.'

  remake:
    # Note that we tried using --overwrite, but that seems to delete the entire modules/dkan folder which includes both checked-in modules and modules from make.
    # So, we delete the specific folders.
    cmd: |
      rm -rf docroot/profiles/dkan/modules/dkan/dkan_dataset ;
      rm -rf docroot/profiles/dkan/modules/dkan/dkan_datastore ;
      rm -rf docroot/profiles/dkan/modules/contrib ;
      echo "removed dkan/modules folders created by make and running a fresh drush make."
      ahoy drush --root=docroot -y make --no-core --contrib-destination=./ dkan/drupal-org.make --no-recursion --no-cache --verbose --working-copy docroot/profiles/dkan
    usage: Rebuild all the dkan projects from the drupal-org.make file using drush make.

  reinstall:
    cmd:  ahoy drush "si dkan --root=docroot  --site-name='DKAN' install_configure_form.update_status_module='array\(FALSE,FALSE\)' --yes"
    usage: Reinstall the dkan install profile (db only).
  drush:
    cmd: drush {{args}}
    usage: Run drush natively.
  confirm:
    cmd: ahoy -f dkan/.ahoy/utils.ahoy.yml confirm {{args}}
    usage: Utility command for creating user prompts.
    hide: true
